%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#4A90E2','primaryTextColor':'#fff','primaryBorderColor':'#2E5C8A','lineColor':'#2E5C8A','secondaryColor':'#50C878','tertiaryColor':'#FFB84D'}}}%%

flowchart TD
    Start([Customer Email<br/>with box3 tag]) --> WelcomeWebhook[ğŸ”— Workflow 1:<br/>AI Generate Welcome]

    WelcomeWebhook --> AIWelcome[ğŸ¤– AI Agent:<br/>Personalized Welcome Email<br/>+ Add DOCS_REQUESTED tag]
    AIWelcome --> DocsReq[ğŸ·ï¸ Tag:<br/>DOCS_REQUESTED]

    DocsReq --> WaitDocs{Customer<br/>Uploads Docs?}

    WaitDocs -->|No - After 2 days| Reminder1[ğŸ“§ Workflow 5:<br/>Reminder 1: Upload]
    Reminder1 --> WaitDocs

    WaitDocs -->|No - After 7 days| Reminder2[ğŸ“§ Workflow 6:<br/>Reminder 2: Final]
    Reminder2 --> WaitDocs

    WaitDocs -->|Yes - Customer replies with attachment| AttachCheck[âœ“ Workflow 2:<br/>Attachment Detection<br/>NO AI NEEDED]
    AttachCheck --> DocsReceived[ğŸ·ï¸ Add Tag:<br/>DOCS_RECEIVED]

    DocsReceived --> Route1[ğŸ“§ Workflow 4:<br/>Route to Intake]
    Route1 --> AssignIntake[Assign: Intake Agent<br/>ID: 22]
    Route1 --> AddTagReview[ğŸ·ï¸ Add Tag:<br/>DOCS_UNDER_REVIEW]

    AssignIntake --> IntakeAnalyze[ğŸ‘¤ Intake Agent:<br/>Analyze Tax Return]
    IntakeAnalyze --> DetermineQ{Which Questions<br/>Needed?}
    DetermineQ --> QBlocks[Question Categories:<br/>WONING, BELEGGINGEN,<br/>SPAARGELD, SCHULDEN]

    QBlocks --> ManualTrigger1[ğŸ‘† MANUAL Workflow 7:<br/>Agent executes<br/>Send Questions<br/><em>Quality control checkpoint</em>]
    ManualTrigger1 --> QSent[ğŸ·ï¸ Add Tag:<br/>QUESTIONS_SENT]

    QSent --> WaitAnswers[â±ï¸ Wait for<br/>Customer Answers]
    WaitAnswers --> CustomerAnswers[Customer Replies<br/>with Answers]
    CustomerAnswers --> IntentDetect2[ğŸ¤– Workflow 3:<br/>Intent Detection<br/>Auto-adds QUESTIONS_ANSWERED]
    IntentDetect2 --> QAnswered[ğŸ·ï¸ Add Tag:<br/>QUESTIONS_ANSWERED]

    QAnswered --> Route2[ğŸ“§ Workflow 8:<br/>Route to Fiscalist]
    Route2 --> AssignFiscalist[Assign: Quote Agent<br/>Fiscalist ID: 23]

    AssignFiscalist --> FiscalCalc[ğŸ‘¤ Fiscalist:<br/>Calculate Offer]
    FiscalCalc --> CalcDetails[Determine:<br/>â€¢ Expected refund range<br/>â€¢ Fee amount<br/>â€¢ Success probability]

    CalcDetails --> ManualTrigger2[ğŸ‘† MANUAL Workflow 9:<br/>Fiscalist executes<br/>Send Offer<br/><em>Quality control checkpoint</em>]
    ManualTrigger2 --> OfferSent[ğŸ·ï¸ Add Tag:<br/>OFFER_SENT]
    ManualTrigger2 --> AssignPayment[Assign: Payment Agent<br/>ID: 26]

    AssignPayment --> WaitAccept{Customer<br/>Accepts?}

    WaitAccept -->|No - After 3 days| OfferRem1[ğŸ“§ Workflow 10:<br/>Reminder 1: Offer]
    OfferRem1 --> WaitAccept

    WaitAccept -->|No - After 10 days| OfferRem2[ğŸ“§ Workflow 11:<br/>Reminder 2: Final + Decline Option]
    OfferRem2 --> WaitAccept

    WaitAccept -->|Customer: ik wil niet verder| IntentDetect3[ğŸ¤– Workflow 3:<br/>Intent Detection]
    IntentDetect3 --> ClosedLost[ğŸ·ï¸ Add Tag:<br/>CLOSED_LOST]
    ClosedLost --> CloseEmail[ğŸ“§ Workflow 12:<br/>Closing Email]
    CloseEmail --> End1([End:<br/>Closed Lost])

    WaitAccept -->|Yes - Customer accepts| IntentDetect4[ğŸ¤– Workflow 3:<br/>Intent Detection]
    IntentDetect4 --> ProposalAccepted[ğŸ·ï¸ Add Tag:<br/>Proposal_Accepted]
    ProposalAccepted --> Email4b[ğŸ“§ Workflow 13:<br/>Payment & Sign Email]
    Email4b --> PaymentStart[ğŸ·ï¸ Add Tag:<br/>PAYMENT_STARTED]

    PaymentStart --> WaitPayment[â±ï¸ Wait for<br/>External Payment System]
    WaitPayment --> PaymentWebhook[ğŸ”— External Webhook:<br/>Payment Completed]
    PaymentWebhook --> SignedPaid[ğŸ·ï¸ Add Tag:<br/>SIGNED_AND_PAID]

    SignedPaid --> Email5[ğŸ“§ Workflow 14:<br/>Email 5: Confirmation]
    Email5 --> StatusActive[Set Status: Active]
    StatusActive --> Success([Success:<br/>Ready to Start<br/>Fiscalist Assigned])

    %% AI Draft runs throughout
    AssignIntake -.-> AIDraft[ğŸ¤– Workflow 15:<br/>AI Draft Generator]
    AssignFiscalist -.-> AIDraft
    AssignPayment -.-> AIDraft
    AIDraft -.-> AgentReview[Agent Reviews Draft<br/>Before Sending]

    %% Styling
    classDef webhookStyle fill:#4A90E2,stroke:#2E5C8A,stroke-width:3px,color:#fff
    classDef workflowStyle fill:#50C878,stroke:#2E8B57,stroke-width:2px,color:#fff
    classDef aiStyle fill:#9B59B6,stroke:#7D3C98,stroke-width:3px,color:#fff
    classDef stateStyle fill:#FFB84D,stroke:#E67E22,stroke-width:2px,color:#000
    classDef manualStyle fill:#E74C3C,stroke:#C0392B,stroke-width:3px,color:#fff
    classDef agentStyle fill:#3498DB,stroke:#2874A6,stroke-width:2px,color:#fff
    classDef endStyle fill:#95A5A6,stroke:#7F8C8D,stroke-width:2px,color:#fff

    class Reminder1,Reminder2,Route1,Route2,OfferRem1,OfferRem2,CloseEmail,Email4b,Email5 workflowStyle
    class IntentDetect2,IntentDetect3,IntentDetect4,AIWelcome,AIDraft aiStyle
    class DocsReq,DocsReceived,AddTagReview,QSent,QAnswered,OfferSent,ClosedLost,ProposalAccepted,PaymentStart,SignedPaid stateStyle
    class ManualTrigger1,ManualTrigger2 manualStyle
    class AssignIntake,AssignFiscalist,AssignPayment,IntakeAnalyze,FiscalCalc agentStyle
    class WelcomeWebhook,PaymentWebhook webhookStyle
    class End1,Success,StatusActive endStyle
